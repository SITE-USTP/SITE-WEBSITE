---
import { type CollectionEntry, getEntry } from "astro:content";
import "./PostCard.css";

interface Props {
    post: CollectionEntry<"posts">;
}

const { post } = Astro.props;
const { title, pubDate, image, tags } = post.data;
const slug = post.slug;

let authorName = "";
let authorAvatar = "";

if (post.data.author) {
    // Handle TinaCMS reference path (e.g., "src/content/officers/john-doe.md")
    const authorSlug = post.data.author.split("/").pop()?.replace(".md", "");
    if (authorSlug) {
        const authorEntry = await getEntry("officers", authorSlug);
        if (authorEntry) {
            authorName = authorEntry.data.name;
            authorAvatar = authorEntry.data.avatar || "";
        }
    }
}

const formattedDate = pubDate.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});
---

<a href={`/blog/${slug}`} class="post-card">
    {
        image && (
            <div class="post-card-image-container">
                <img src={image} alt={title} class="post-card-image" />
            </div>
        )
    }
    <div class="post-card-content">
        <div class="post-card-meta">
            <time datetime={pubDate.toISOString()} class="post-card-date"
                >{formattedDate}</time
            >
        </div>
        <h3 class="post-card-title">
            {title}
        </h3>
        <p class="post-card-excerpt">
            {post.body.substring(0, 150)}...
        </p>

        <div class="post-card-footer">
            {
                authorName && (
                    <div class="post-card-author">
                        {authorAvatar && (
                            <img
                                src={authorAvatar}
                                alt={authorName}
                                class="post-card-author-avatar"
                            />
                        )}
                        <span class="post-card-author-name">{authorName}</span>
                    </div>
                )
            }
            {
                tags && tags.length > 0 && (
                    <div class="post-card-tags">
                        {tags.slice(0, 2).map((tag) => (
                            <span class="post-card-tag">#{tag}</span>
                        ))}
                    </div>
                )
            }
        </div>
    </div>
</a>
